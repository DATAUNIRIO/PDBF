	</script>

	<script src="dygraphs.js"></script>
	<script src="diff_match_patch.js"></script>
	<script src="alasql.min.js"></script>

	<style>
	.dygraph-label {
		font-family: sans-serif;
	}
	
	html {
		font-family: sans-serif;
	}
	</style>
	
  </head>

  <body onLoad="overlay()" style="width:100%; height:100%;">

<script>
//Load dim.json
var json;
json = JSON.parse(UTF8ArrToStr(base64DecToArr(dim_base64)));
tmpw = json.width / 655 / 30;
tmph = json.height / 655 / 30;

function replaceAll(str, s, r) {
	return str.split(s).join(r);
}
	
//Load db.sql
//Create the database
alasql(UTF8ArrToStr(base64DecToArr(db_base64)));

//Load config.json
json = JSON.parse(UTF8ArrToStr(base64DecToArr(json_base64)));
var width = (json.type.I.x2 - json.type.I.x1);
var height = (json.type.I.y1 - json.type.I.y2);
outw = tmpw*width;
outh = tmph*height;
var pageOverlays = [];
parse(json);
function isValidDate(d) {
  if ( Object.prototype.toString.call(d) !== "[object Date]" )
    return false;
  return !isNaN(d.getTime());
}
function parse(json) {
	page = 0;
	pageOverlay = pageOverlays[page];
	if (typeof pageOverlay == 'undefined') {
		pageOverlay = [];
		pageOverlays[page] = pageOverlay;
	}
	pageOverlay[pageOverlay.length] = json;
}
function display(json, page) {
	var container = document.createElement('div');
	container.id = json.name;
	var style = "width:100%; height:100%;";
	switch(json.type.C) {
		case "pdbf.common.LineChart":
		case "pdbf.common.BarChart":
			try {
			var results = alasql(json.type.I.query);
			if (results.length == 0) {
				alert("Query \"" + json.type.I.query + "\" returns empty result!");
				return;
			}
			if (results[0] instanceof Array) {
				alert("Query \"" + json.type.I.query + "\" contains multiple statements!");
				return;
			}
			var values = [];
			var columns = [];
			for (key in results[0]) {
				columns[columns.length] = replaceAll(key, '_', ' ');
			}
			for (var i=0; i<results.length; i++) {
				var cur = results[i];
				var val = [];
				for(key in cur) {
					if (typeof(cur[key]) == "string") {
						var fail = true;
						var tmp;
						try {
							tmp = new Date(replaceAll(cur[key], "-", "/"));
							if (isValidDate(tmp)) {
								val[val.length] = tmp;
								fail = false;
							}
						} catch (e) {
						}
						if (fail) {
							try {
								tmp = Number(cur[key]);
								if (!isNaN(tmp)) {
									val[val.length] = tmp;
									fail = false;
								}
							} catch (e) {
							}
						}
						if (fail) {
							alert("Parsing of " + tmp + " failed!");
							return;
						}
					} else {
						val[val.length] = cur[key];
					}
				}
				values[values.length] = val;
			}
			var options = { labels: columns, animatedZooms: true, legend: "always", logscale: json.type.I.logScale, xlabel: json.type.I.xUnitName, ylabel: json.type.I.yUnitName, labelsDivStyles: { 'text-align': 'right', 'background': 'none' } };
			var addOpt = JSON.parse(json.type.I.options);
			for(var key in addOpt){
				options[key] = addOpt[key];
			}
			var g = new Dygraph(container, values, options );
			style = "background: white;" + style;
			container.setAttribute('style', style);
			page.appendChild(container);
			g.resize();
			} catch(e) {
				alert(e);
			}
			break;
		case "pdbf.common.Text":
			container.addEventListener("click", function(){editor.setValue(json.type.I.query); execEditorContents();});
			container.setAttribute('style', style);
			page.appendChild(container);
			break;
		default:
			alert("Unknown: " + json.type.C);
			break;
	}
}
function overlay() {
  	var pageNr = 0;
	for (var i = 0; i < pageOverlays[pageNr].length; ++i) {
		display(pageOverlays[pageNr][i], document.body)
	}
}

</script>

  </body>
</html>