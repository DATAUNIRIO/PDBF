<html>
<head>
<meta charset="utf-8">
<link rel="stylesheet" href="pivot.css" />
<link rel="stylesheet" href="codemirror.css" />
<link rel="stylesheet" href="jquery.dataTables.css" />
<link rel="stylesheet" href="c3.css" />

<script src="base64.js"></script>
<script src="d3.js"></script>
<script src="alasql.js"></script>
<script src="codemirror-compressed.js"></script>
<script src="c3.js"></script>
<script src="excanvas.compiled.js"></script>
<script src="diff_match_patch.js"></script>
<script src="jquery-1.11.2.min.js"></script>
<script src="pivot.js"></script>
<script src="jquery-ui-1.9.2.custom.min.js"></script>
<script src="jquery.dataTables.js"></script>
<script src="main.js"></script>

<style>
div {
	border: 0px solid black;
	font-family: sans-serif;
}
</style>
</head>
<body>
	<center>
		<div id="overlay"></div>
	</center>
	<script>
		var zoomFactor = 1.25;
		var overlay = document.getElementById("overlay");
		alasql("CREATE TABLE data1 (date DATE, money INTEGER); "
				+ "CREATE TABLE data2 (date DATE, runtimeA REAL, runtimeB REAL); "
				+ "INSERT INTO data1 VALUES ('2008/05/07', 75), ('2008/05/08', 70), ('2008/05/09', 80), ('2008/05/10', 100), ('2008/05/11', 200), ('2008/05/12', 100), ('2008/05/13', 50), ('2008/05/14', 200), ('2008/05/15', 2000); "
				+ "INSERT INTO data2 VALUES ('2008/05/07', 75.32, 72.58), ('2008/05/08', 74.16, 71.36), ('2008/05/09', 76.58, 70.24), ('2008/05/10', 70.46, 69.56), ('2008/05/11', 69.27, 69.18), ('2008/05/12', 66.91, 68.45), ('2008/05/13', 60.94, 67.34), ('2008/05/14', 62.16, 66.93), ('2008/05/15', 59.47, 66.34); "
				+ "CREATE TABLE test (col1 INTEGER, col2 REAL); "
				+ "INSERT INTO test VALUES (1,111.1), (2,222.1);");
		var json = {
			"name" : "Overlay1",
			"type" : {
				"C" : "pdbf.common.BarChart",
				"I" : {
					bottomArr : [ {
						text : "Bottom",
						c : 2
					} ],
					topArr : [ {
						text : "Top",
						c : 2
					} ],
					rightArr : [ {
						text : "Right",
						c : 1
					}, {
						text : "Right2",
						c : 1
					} ],
					leftArr : [ {
						text : "Affe",
						c : 1
					}, {
						text : "AffeAffeAffeAffe Right",
						c : 1
					} ],
					xValues : [ "runtimeA AS [engine A]",
							"runtimeB AS [engine B]" ],
					yValues : [ "date <= \"2008/05/10\"", "date > \"2008/05/10\"" ],
					xCount : 2,
					yCount : 2,
					yFirst: true,
					forceXequal: true,
					forceYequal: true,
					"logScale" : false,
					"legendpos" : "topright",
					"xUnitName" : "Date",
					"yUnitName" : "Runtime [in sec]",
					"includeZero" : false,
					"drawPoints" : false,
					"fillGraph" : false,
					"showRangeSelector" : false,
					"overlap" : -1,
					"rows" : "",
					"cols" : "",
					"aggregation" : "Minimum",
					"aggregationattribute" : "",
					"aggregationBig" : "Minimum",
					"aggregationattributeBig" : "",
					"query" : "SELECT date, ? FROM data2 WHERE ?;",
					"queryB" : "SELECT date, ? FROM data2 WHERE ?;",
					"x1" : 0.08790569787893156,
					"x2" : 0.4817233217474389,
					"y1" : 0.9320729072121383,
					"y2" : 0.6886264350593185,
					"page" : 4,
					"options" : "{\"axis\": { \"x\": { \"type\": \"timeseries\", \"tick\": { \"fit\":true } } }}",
					"zoom" : 0.75,
					"quality" : 1,
					"fontsize" : 9
				}
			}
		};

		function buildContainerMultiplotChart(container, json, zoomFactor,
				style, containerOver, enableFullscreenButton) {
			if (enableFullscreenButton) {
				var fullscreen = getFullscreenDiv();
				container.appendChild(fullscreen);
				fullscreen.addEventListener("click", function() {
					containerOver.style.visibility = 'visible';
					containerOver.style.opacity = 1;
				});
			}

			function getLeft(countRows, text, td) {
				var div = document.createElement('div');
				div.className = 'vertical-text';
				div.setAttribute('style', 'width: ' + left + 'px;');
				td.appendChild(div);
				td.setAttribute('rowspan', countRows);
				div.innerHTML = "<div class=\"vertical-text__innerL\">" + text
						+ "</div>";
			}

			function getRight(countRows, text, td) {
				var div = document.createElement('div');
				div.className = 'vertical-text';
				div.setAttribute('style', 'width: ' + right + 'px;');
				td.appendChild(div);
				td.setAttribute('rowspan', countRows);
				div.innerHTML = "<div class=\"vertical-text__innerR\">" + text
						+ "</div>";
			}

			function getTop(countCols, text, td) {
				td.setAttribute('style', 'height: 1.5em; width: ' + w + 'px;');
				td.setAttribute('colspan', countCols);
				td.innerHTML = text;
			}

			function getBottom(countCols, text, td) {
				td.setAttribute('style', 'height: 1.5em; width: ' + w + 'px;');
				td.setAttribute('colspan', countCols);
				td.innerHTML = text;
			}

			container.setAttribute('style', style);

			var overlay = container;
			var xCount = json.type.I.xCount;
			var yCount = json.type.I.yCount;
			var leftArr = json.type.I.leftArr;
			if (leftArr != undefined) leftArr = jQuery.extend(true, {}, leftArr); //Copy
			var rightArr = json.type.I.rightArr;
			if (rightArr != undefined) rightArr = jQuery.extend(true, {}, rightArr); //Copy
			var topArr = json.type.I.topArr;
			if (topArr != undefined) topArr = jQuery.extend(true, {}, topArr); //Copy
			var bottomArr = json.type.I.bottomArr;
			if (bottomArr != undefined) bottomArr = jQuery.extend(true, {}, bottomArr); //Copy
			var xValues = json.type.I.xValues;
			var yValues = json.type.I.yValues;
			var queryBackup = json.type.I.query;
			var yFirst = json.type.I.yFirst;
			var forceXequal = json.type.I.forceXequal;
			var forceYequal = json.type.I.forceYequal;

			if (((queryBackup.match(/\?/g) || []).length) != 2) {
				alert("Query for multiplot must contain exactly 2 occurrences of \"?\"\nQuery was: "
						+ queryBackup);
			}

			if (leftArr.length == undefined) {
				leftArr = [ {
					text : json.type.I.yUnitName,
					c : yCount
				} ];
			}
			if (rightArr.length == undefined) {
				rightArr = [];
				for (var i = 0; i < yValues.length; ++i) {
					rightArr[rightArr.length] = {
						text : yValues[i],
						c : 1
					};
				}
			}
			if (topArr.length == undefined) {
				topArr = [];
				for (var i = 0; i < xValues.length; ++i) {
					topArr[topArr.length] = {
						text : xValues[i],
						c : 1
					};
				}
			}
			if (bottomArr.length == undefined) {
				bottomArr = [ {
					text : json.type.I.xUnitName,
					c : xCount
				} ];
			}
			
			if (yFirst) {
			    var tmp = rightArr;
				rightArr = topArr;
				topArr = tmp;
			}

			//TODO: right now only one line labels are supported!
			var fontbasesize = 13;
			var left = leftArr.length != 0 ? fontbasesize * zoomFactor * 1.6
					: 0;
			var right = rightArr.length != 0 ? fontbasesize * zoomFactor * 1.6
					: 0;
			var top = topArr.length != 0 ? fontbasesize * zoomFactor * 1.6 : 0;
			var bottom = bottomArr.length != 0 ? fontbasesize * zoomFactor
					* 1.6 : 0;
			var options = getChartOptions(json, zoomFactor, {});
			var legend = options.legend.show ? fontbasesize * zoomFactor * 1.6 : 0;
			var inner = document.createElement('table');
			var charts = [];
			inner
					.setAttribute(
							'style',
							'height: 100%; width: 100%; border-collapse: collapse; text-align:center; font-size: '
									+ fontbasesize
									* zoomFactor
									+ 'px; font-weight: bold;');
			overlay.appendChild(inner);

			var css = document.createElement('style');
			css.setAttribute('scoped', 'scoped');
			overlay.appendChild(css);
			css.innerHTML = 'td {padding:0;}';

			var overlaywidth = $(overlay).width();
			var overlayheight = $(overlay).height();

			var nextLeft = 0;
			var nextRight = 0;

			var h = Math.floor((overlayheight - top - bottom - legend - 1) / yCount);
			var w = Math.floor((overlaywidth - left - right - 1) / xCount);
			var style = 'width: ' + w + 'px;' + 'height: ' + h + 'px;';
			
			var yExtent;
			var xExtent = [];

			if (top != 0) {
				var tr = document.createElement('tr');
				inner.appendChild(tr);
				if (left != 0) {
					var td = document.createElement('td');
					tr.appendChild(td);
				}
				while (topArr.length != 0) {
					var cur = topArr.shift();
					var td = document.createElement('td');
					tr.appendChild(td);
					getTop(cur.c, cur.text, td);
				}
				if (right != 0) {
					var td = document.createElement('td');
					tr.appendChild(td);
				}
			}
			for (var y = 0; y < yCount; ++y) {
				var tr = document.createElement('tr');
				inner.appendChild(tr);
				if (y == nextLeft) {
					var cur = leftArr.shift();
					var td = document.createElement('td');
					tr.appendChild(td);
					getLeft(cur.c, cur.text, td);
					nextLeft += cur.c;
				}
				for (var x = 0; x < xCount; ++x) {
					var td = document.createElement('td');
					tr.appendChild(td);
					td.setAttribute('style', style);
					var cellInner = document.createElement('div');
					cellInner.setAttribute('style', style);
					td.appendChild(cellInner);

					var cellquery = queryBackup;
					if (yFirst) {
						cellquery = cellquery.replace("?", xValues[y]);
						cellquery = cellquery.replace("?", yValues[x]);
					} else {
						cellquery = cellquery.replace("?", xValues[x]);
						cellquery = cellquery.replace("?", yValues[y]);
					}
					json.type.I.query = cellquery;

					if (x % xCount != 0) {
						defaultChartOptions.noyticks = true;
					} else {
						defaultChartOptions.noyticks = false;
					}
					if (y % yCount != yCount - 1) {
						defaultChartOptions.noxticks = true;
					} else {
						defaultChartOptions.noxticks = false;
					}
					
					var chartdata = getChartData(json);
					var options = getChartOptions(json, zoomFactor, chartdata.values, cellInner);
					
					if (forceYequal) {
						if (x != 0) {
							//replace y extent
							options.axis.y.min = yExtent[0];
							options.axis.y.max = yExtent[1];
							options.axis.y.padding = {top:0, bottom:0};
						} 
					}
					if (forceXequal) {
						if (y != 0) {
							//replace x extent
							options.axis.x.min = xExtent[x][0];
							options.axis.x.max = xExtent[x][1];
							options.axis.x.padding = {left:0, right:0};
						} 
					}
					
					delete options.axis.y.label;
					delete options.axis.x.label;
					options.legend.show = false;
					
					var chart = c3.generate(options);
					charts[charts.length] = chart;
					
					if (forceYequal) {
						if (x == 0) {
							//save y extent
							yExtent = chart.yd();
						} 
					}
					if (forceXequal) {
						if (y == 0) {
							//save y extent
							xExtent[x] = chart.xd();
						} 
					}
				}
				if (y == nextRight) {
					var cur = rightArr.shift();
					var td = document.createElement('td');
					tr.appendChild(td);
					getRight(cur.c, cur.text, td);
					nextRight += cur.c;
				}
			}
			if (bottom != 0) {
				var tr = document.createElement('tr');
				inner.appendChild(tr);
				if (left != 0) {
					var td = document.createElement('td');
					tr.appendChild(td);
				}
				while (bottomArr.length != 0) {
					var cur = bottomArr.shift();
					var td = document.createElement('td');
					tr.appendChild(td);
					getBottom(cur.c, cur.text, td);
				}
				if (right != 0) {
					var td = document.createElement('td');
					tr.appendChild(td);
				}
			}
			
			if (legend != 0) {
				var tr = document.createElement('tr');
				inner.appendChild(tr);
				if (left != 0) {
					var td = document.createElement('td');
					tr.appendChild(td);
				}
				
				var td = document.createElement('td');
				tr.appendChild(td);
				td.setAttribute('style', 'height: 1.5em; width: ' + w + 'px;');
				td.setAttribute('colspan', cur.c);
					
				if (right != 0) {
					var td = document.createElement('td');
					tr.appendChild(td);
				}
				
				
				//TODO: calculate this; maybe get value right before chart creation
				//TODO: fix colors and prettify legend
				//TODO: fix legend position
				var legendItems = ['engine A', 'engine B'];
				var colors = {};
				colors['engine A'] = 'rgb(31, 119, 180)';
				colors['engine B'] = 'rgb(31, 119, 180)';
				
				d3.select(td).insert('div', '.chart').attr('class', 'legend').selectAll('span')
			    .data(legendItems)
			  .enter().append('span')
			    .attr('data-id', function (id) { return id; })
			    .html(function (id) { return id; })
			    .each(function (id) {
			        d3.select(this).style('background-color', colors[id]);
			    })
			    .on('mouseover', function (id) {
			        charts.forEach(function(c, i, a) {c.focus(id);});
			    })
			    .on('mouseout', function (id) {
			    	charts.forEach(function(c, i, a) {
			    		legendItems.forEach(function(c2, i2, a2) {
			    			c.revert(c2);
			    		});
			    	});
			    })
			    .on('click', function (id) {
			    	charts.forEach(function(c, i, a) {c.toggle(id);});
			    });
			}

			json.type.I.query = queryBackup;
			defaultChartOptions.noxticks = false;
			defaultChartOptions.noyticks = false;
		}

		buildContainerMultiplotChart(overlay, json, zoomFactor, "border: 1px solid black; width: 800px; height: 600px;", null, false);
		overlay.innerHTML = "";
		buildContainerMultiplotChart(overlay, json, zoomFactor, "border: 1px solid black; width: 800px; height: 600px;", null, false);
	</script>
</body>
</html>