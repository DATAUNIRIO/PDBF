% TODO: switcher, table, picasso diag
\def\filedate{2015/02/23}
\def\fileversion{1.0}
\NeedsTeXFormat{LaTeX2e}
\AtEndOfPackage{\ProvidesPackage{PDBF}
             [\filedate\space\space\space\space\fileversion\space\space\space\space(Patrick Bender)]}
\RequirePackage{zref-savepos}
\RequirePackage{zref-abspage}
\RequirePackage{zref-user}
\RequirePackage{xcolor}
\RequirePackage{graphicx}
\RequirePackage{xstring}
\RequirePackage{kvsetkeys}
\RequirePackage{xparse}

\newcounter{visual}
\newcounter{overlay}

%JSON need double quotes. this is only needed if the package german or ngerman is included
% The following characters could be used in queries: # $ % ^ & _  ~ " \
\def\pdbf@codesbegin{%
	\edef\pdbf@codesend{%
	 	\catcode`\noexpand\"\the\catcode`\"\relax
	 	\catcode`\noexpand\_\the\catcode`\_\relax
	 	\catcode`\noexpand\$\the\catcode`\$\relax
	 	\catcode`\noexpand\~\the\catcode`\~\relax
	}
	\catcode`\"=12
	\catcode`\_=12
	\catcode`\$=12
	\catcode`\~=12
}
\pdbf@codesbegin

\newwrite\tempfile
\immediate\openout\tempfile=config.json
\immediate\write\tempfile{[}

\AtBeginDocument{
	\newwrite\temp
	\immediate\openout\temp=dim.json
	\immediate\write\temp{\@charlb "width": "\number\paperwidth",}
	\immediate\write\temp{"height": "\number\paperheight" \@charrb}
	\immediate\closeout\temp
}

\AtEndDocument{
	\immediate\write\tempfile{]}
	\immediate\closeout\tempfile
}

% # $ ^ & _  ~ " \
\begingroup\lccode`!=`\%\lowercase{\endgroup\def\pdbfPercentchar{!}}
\begingroup\lccode`!=`\#\lowercase{\endgroup\def\pdbfHashchar{!}}
\begingroup\lccode`!=`\$\lowercase{\endgroup\def\pdbfDollarchar{!}}
\begingroup\lccode`!=`\^\lowercase{\endgroup\def\pdbfCaretchar{!}}
\begingroup\lccode`!=`\&\lowercase{\endgroup\def\pdbfAndchar{!}}
\begingroup\lccode`!=`\_\lowercase{\endgroup\def\pdbfUnderscorechar{!}}
\begingroup\lccode`!=`\~\lowercase{\endgroup\def\pdbfTildechar{!}}
\begingroup\lccode`!=`\\\lowercase{\endgroup\def\pdbfBackslashchar{!}}
\def\~{\pdbfTildechar}

\define@key{pdbf}{width}{\def\pdbf@width{#1}}
\define@key{pdbf}{height}{\def\pdbf@height{#1}}
\def\pdbf@xunitname{undefined}
\define@key{pdbf}{xunit}[undefined]{\StrSubstitute{#1}{"}{\@backslashchar"}[\pdbf@xunitname]}
\def\pdbf@yunitname{undefined}
\define@key{pdbf}{yunit}[undefined]{\StrSubstitute{#1}{"}{\@backslashchar"}[\pdbf@yunitname]}
\def\pdbf@options{{}}
\define@key{pdbf}{options}{\StrSubstitute{#1}{"}{\@backslashchar"}[\pdbf@opt]\def\pdbf@options{{\pdbf@opt}}}
\def\pdbf@logscale{false}
\define@key{pdbf}{logscale}[true]{\def\pdbf@logscale{#1}}
\def\pdbf@quality{1.0}
\define@key{pdbf}{quality}{\def\pdbf@quality{#1}}
\def\pdbf@zoom{1.0}
\define@key{pdbf}{scale}{\def\pdbf@scale{#1}}

\DeclareRobustCommand\pdbf@save[1]{%
    \begingroup
      \zref@localaddprops{savepos}{abspage}%
      \zsavepos{#1}%
    \endgroup
}

\def\lineChart[#1]#2{%
	\pdbf@codesbegin%
	\setkeys{pdbf}{#1}%
	\ifdefined \pdbf@width \else%
  		\errmessage{^^J ^^J Error: width value missing! ^^J}%
	\fi%
	\ifdefined \pdbf@height \else%
		\errmessage{^^J ^^J Error: height value missing! ^^J}%
	\fi%
	\StrSubstitute{#2}{"}{\@backslashchar"}[\pdbf@query]%
	{\fontsize{5pt}{1sp}\selectfont%
		\stepcounter{visual}%
		\stepcounter{overlay}%
		\setlength\tabcolsep{1sp}%
		% Place Image
		\begin{tabular}{lll}%
		\pdbf@save{Overlay\arabic{visual}1}&&\\%
		\IfFileExists{Overlay\arabic{visual}.png}{%
	    		&\includegraphics[width=\pdbf@width, height=\pdbf@height]{Overlay\arabic{visual}.png}&\\%
		}{%
	    		&\includegraphics[width=\pdbf@width, height=\pdbf@height]{out/web/dummy.png}&\\%
		}%
		&&\zsavepos{Overlay\arabic{visual}2}\\%
		\end{tabular}%
		% Write part of config.json
		\ifnum \value{overlay} > 1%
			\immediate\write\tempfile{,\@charlb}%
		\else%
			\immediate\write\tempfile{\@charlb}%
		\fi%
		\immediate\write\tempfile{\space\space\space\space"name": "Overlay\arabic{visual}",}%
		\immediate\write\tempfile{\space\space\space\space"type": \@charlb}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space"C": "pdbf.common.LineChart",}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space"I": \@charlb}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"logScale": \pdbf@logscale,}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"xUnitName": "\pdbf@xunitname",}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"yUnitName": "\pdbf@yunitname",}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"query": "\pdbf@query",}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"options": "\pdbf@options",}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"quality": \pdbf@quality,}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"zoom": \pdbf@zoom,}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"x1": \zposx{Overlay\arabic{visual}1},}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"x2": \zposx{Overlay\arabic{visual}2},}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"y1": \zposy{Overlay\arabic{visual}1},}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"y2": \zposy{Overlay\arabic{visual}2},}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"page": \zref@extract{Overlay\arabic{visual}1}{abspage}}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space\@charrb}%
		\immediate\write\tempfile{\space\space\space\space\@charrb}%
		\immediate\write\tempfile{\@charrb}%
	}%
	\pdbf@codesend%
}

\def\sqlmult#1#2{%
	\pdbf@codesbegin%
	\edef\pdbf@fontsave{\f@size}%
	{\fontsize{5pt}{1sp}\selectfont%
		\stepcounter{visual}%
		\stepcounter{overlay}%
		\setlength\tabcolsep{1sp}%
		\begin{tabular}[t]{lll}%
		\pdbf@save{Overlay\arabic{visual}1}&{\color{blue} \fontsize{\pdbf@fontsave}{1sp}\selectfont #1 }&\\%
		&&\zsavepos{Overlay\arabic{visual}2}\\%
		\end{tabular}%
		% Write part of config.json
		\StrSubstitute{#2}{"}{\@backslashchar"}[\pdbf@query]%
		\ifnum \value{overlay} > 1%
			\immediate\write\tempfile{,\@charlb}%
		\else%
			\immediate\write\tempfile{\@charlb}%
		\fi%
		\immediate\write\tempfile{\space\space\space\space"name": "Overlay\arabic{visual}",}%
		\immediate\write\tempfile{\space\space\space\space"type": \@charlb}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space"C": "pdbf.common.Text",}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space"I": \@charlb}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"query": "\pdbf@query",}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"x1": \zposx{Overlay\arabic{visual}1},}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"x2": \zposx{Overlay\arabic{visual}2},}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"y1": \zposy{Overlay\arabic{visual}1},}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"y2": \zposy{Overlay\arabic{visual}2},}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"fontsize": \pdbf@fontsave,}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"page": \zref@extract{Overlay\arabic{visual}1}{abspage}}%
		\immediate\write\tempfile{\space\space\space\space\space\space\space\space\@charrb}%
		\immediate\write\tempfile{\space\space\space\space\@charrb}%
		\immediate\write\tempfile{\@charrb}%
	}%
	\pdbf@codesend%
}

\def\sql#1{
	\sqlmult{#1}{#1}
}
	
\DeclareRobustCommand\DBSQLText[1]{%
	\stepcounter{overlay}%
	\StrSubstitute{#1}{"}{\@backslashchar"}[\pdbf@value]%
	\ifnum \value{overlay} > 1%
		\immediate\write\tempfile{,\@charlb}%
	\else%
		\immediate\write\tempfile{\@charlb}%
	\fi%
	\immediate\write\tempfile{\space\space\space\space"name": "Database",}%
	\immediate\write\tempfile{\space\space\space\space"type": \@charlb}%
	\immediate\write\tempfile{\space\space\space\space\space\space\space\space"C": "pdbf.common.Database",}%
	\immediate\write\tempfile{\space\space\space\space\space\space\space\space"I": \@charlb}%
	\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"type": 1,}%
	\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"value1": "\pdbf@value"}%
	\immediate\write\tempfile{\space\space\space\space\space\space\space\space\@charrb}%
	\immediate\write\tempfile{\space\space\space\space\@charrb}%
	\immediate\write\tempfile{\@charrb}%
}

\DeclareRobustCommand\DBSQLFile[1]{%
	\stepcounter{overlay}%
	\StrSubstitute{#1}{"}{\@backslashchar"}[\pdbf@value]%
	\ifnum \value{overlay} > 1%
		\immediate\write\tempfile{,\@charlb}%
	\else%
		\immediate\write\tempfile{\@charlb}%
	\fi%
	\immediate\write\tempfile{\space\space\space\space"name": "Database",}%
	\immediate\write\tempfile{\space\space\space\space"type": \@charlb}%
	\immediate\write\tempfile{\space\space\space\space\space\space\space\space"C": "pdbf.common.Database",}%
	\immediate\write\tempfile{\space\space\space\space\space\space\space\space"I": \@charlb}%
	\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"type": 2,}%
	\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"value1": "\pdbf@value"}%
	\immediate\write\tempfile{\space\space\space\space\space\space\space\space\@charrb}%
	\immediate\write\tempfile{\space\space\space\space\@charrb}%
	\immediate\write\tempfile{\@charrb}%
}

\DeclareRobustCommand\DBSQLJDBC[4]{%
	\stepcounter{overlay}%
	\StrSubstitute{#1}{"}{\@backslashchar"}[\pdbf@valueA]%
	\StrSubstitute{#2}{"}{\@backslashchar"}[\pdbf@valueB]%
	\StrSubstitute{#3}{"}{\@backslashchar"}[\pdbf@valueC]%
	\StrSubstitute{#4}{"}{\@backslashchar"}[\pdbf@valueD]%
	\ifnum \value{overlay} > 1%
		\immediate\write\tempfile{,\@charlb}%
	\else%
		\immediate\write\tempfile{\@charlb}%
	\fi%
	\immediate\write\tempfile{\space\space\space\space"name": "Database",}%
	\immediate\write\tempfile{\space\space\space\space"type": \@charlb}%
	\immediate\write\tempfile{\space\space\space\space\space\space\space\space"C": "pdbf.common.Database",}%
	\immediate\write\tempfile{\space\space\space\space\space\space\space\space"I": \@charlb}%
	\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"type": 3,}%
	\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"value1": "\pdbf@valueA",}%
	\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"value2": "\pdbf@valueB",}%
	\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"value3": "\pdbf@valueC",}%
	\immediate\write\tempfile{\space\space\space\space\space\space\space\space\space\space\space\space"value4": "\pdbf@valueD"}%
	\immediate\write\tempfile{\space\space\space\space\space\space\space\space\@charrb}%
	\immediate\write\tempfile{\space\space\space\space\@charrb}%
	\immediate\write\tempfile{\@charrb}%
}

\pdbf@codesend

\endinput
